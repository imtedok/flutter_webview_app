workflows:
  # Flutteræ„å»ºæµæ°´çº¿
  flutter-workflow:
    name: Flutter Workflow
    instance_type: mac_mini_m2
    max_build_duration: 120
    # integrations:
    #   app_store_connect: for_codemagic
    environment:
      groups:
        - cloudflare_credentials # <-- (Includes CLOUDFLARE_API_TOKEN, CLOUDFLARE_ACCOUNT_ID)
      # androidç­¾åä¿¡æ¯
      android_signing:
        - cc_game_apk_jks
      # iosç­¾åä¿¡æ¯
      # ios_signing:
      #   distribution_type: ad_hoc
      #   # ios åŒ…åå¿…é¡»æŒ‡å®šï¼Œè¯·æ³¨æ„è·Ÿ PACKAGE_NAME é¡»ä¿æŒä¸€è‡´
      #   bundle_identifier: com.ccgametest.live
      vars:
        # è‡ªå®šä¹‰åŒ…åï¼Œä¿®æ”¹åå½±å“è¾ƒå¤§
        # ï¼ˆioså¾—äº‹å…ˆåœ¨è‹¹æœå¼€å‘è€…å¹³å°æ·»åŠ æŒ‡å®šåŒ…åä»¥åŠæè¿°æ–‡ä»¶ä»¥åŠæ¨é€è¯ä¹¦ï¼Œå¹¶ä¸Šä¼ codemagicä»¥åŠæ¨é€å¹³å°ï¼Œandroidåªéœ€æ›´æ–°æ¨é€å¹³å°ä¿¡æ¯ï¼‰
        PACKAGE_NAME: "x.x.x"
        # è‡ªå®šä¹‰å¾…åŠ è½½çš„æå…‰æ¨é€çš„ JPUSH_APP_KEYã€ä¸ PACKAGE_NAME åŒ…åé«˜åº¦ç»‘å®šï¼Œä¸€æ—¦åŒ…åå˜æ›´ï¼Œæ­¤å€¼ä¹Ÿé¡»å˜æ›´ï¼Œä¸»è¦å—æ¨é€å¹³å°å½±å“ã€‘
        JPUSH_APP_KEY: "x"
        # è‡ªå®šä¹‰åº”ç”¨ç‰ˆæœ¬å·
        APP_VERSION: "1.0.2"
        # è‡ªå®šä¹‰åº”ç”¨æ„å»ºå·
        BUILD_NUMBER: "1"
        # è‡ªå®šä¹‰åº”ç”¨åç§°
        APP_NAME: "CCGAME2"
        # è‡ªå®šä¹‰å¾…åŠ è½½çš„ web ç½‘å€ ä»¥åŠ ç½‘å€ä¸­ç”¨æ¥è¯·æ±‚çš„apié“¾æ¥
        WEB_URL: "https://x.com"
        # è‡ªå®šä¹‰appå›¾æ ‡ï¼Œbase64çš„å›¾ç‰‡æ ¼å¼æˆ–å›¾ç‰‡urlé“¾æ¥ï¼Œå›¾åƒå¤§å°ä¸º512x512
        APP_LUNCHER_ICON_BASE64: "-"
        # è‡ªå®šä¹‰appå¯åŠ¨å›¾ï¼Œbase64çš„å›¾ç‰‡æ ¼å¼æˆ–å›¾ç‰‡urlé“¾æ¥ï¼Œå›¾åƒå¤§å°ä¸º786*1738
        APP_SPLASH_SCREEN_BASE64: "-"
        # å…¼å®¹åœ¨android 12+ è®¾å¤‡ä¸Šè®¾ç½®appå¯åŠ¨å›¾ä¸ç”Ÿæ•ˆï¼Œè®¾ç½®å¯åŠ¨é¡µå°å›¾æ ‡ï¼ˆtip: å›¾ç‰‡ç”»å¸ƒå¤§å°ä¸º1152*1152ï¼Œå›¾åƒå¤§å°ä¸º768*768ï¼‰ï¼Œbase64çš„å›¾ç‰‡æ ¼å¼æˆ–å›¾ç‰‡urlé“¾æ¥
        APP_ANDROID12_SPLASH_ICON_BASE64: "-"
        # å…¼å®¹åœ¨android 12+ è®¾å¤‡ä¸Šè®¾ç½®appå¯åŠ¨å›¾ä¸ç”Ÿæ•ˆï¼Œè®¾ç½®å¯åŠ¨é¡µèƒŒæ™¯è‰²ï¼Œæ¥æ”¶16è¿›åˆ¶è‰²å€¼ï¼š#FFFFFF
        APP_ANDROID12_SPLASH_BG: "#FFFFFF"
        # R2é…ç½®
        #CLOUDFLARE_ACCOUNT_ID: ${CLOUDFLARE_ACCOUNT_ID} # æ”¹ç”¨æ§åˆ¶å°å½¢å¼çš„é…ç½®
        #CLOUDFLARE_API_TOKEN: ${CLOUDFLARE_API_TOKEN} # æ”¹ç”¨æ§åˆ¶å°å½¢å¼(æ³¨æ„é…ç½®ä¸ºç§å¯†)çš„é…ç½®
        R2_BUCKET: "xx"
        # æ–‡ä»¶ä¿å­˜è·¯å¾„å¼€å¤´å’Œç»“å°¾æ³¨æ„ä¸è¦æºå¸¦/
        BUCKET_FILEPATH: "xx/xxx"

      flutter: stable
      xcode: latest
      cocoapods: default
    scripts:
      # android. é…ç½®local.properties
      - name: Set up local.properties
        script: |
          echo "flutter.sdk=$HOME/programs/flutter" > "$CM_BUILD_DIR/android/local.properties"

      # ios. è®¾ç½®ç­¾å
      # - name: Set up code signing settings on Xcode project
      #   script: |
      #     xcode-project use-profiles

      # è·å–Flutterä¾èµ–
      - name: Get Flutter packages
        script: |
          flutter pub get

      # flutterï¼šä¿®æ”¹åº”ç”¨åŒ…åï¼ˆandroidã€iosï¼‰ï¼Œæ­¤æ­¥éª¤ä¿®æ”¹ä¹‹åä¼šå½±å“æ¨é€ä¸”iosä¼šæ— æ³•å‡ºåŒ…ï¼Œ
      # è¯·å®šä½è‡³ bundle_identifierï¼ŒPACKAGE_NAMEã€JPUSH_APP_KEYç­‰å˜é‡å¤„å¯¹ç…§å¤„ç†åå†æ‰§è¡Œæ‰“åŒ…è„šæœ¬
      - name: Update android ios package name
        script: |
          echo "Update android ios package name..."
          dart run change_app_package_name:main "${PACKAGE_NAME}"

      # flutterï¼šæ›´æ–°åº”ç”¨åç§°
      - name: Update app name
        script: |
          echo "Updating app name..."
          dart run rename_app:main all="${APP_NAME}"

      # flutterï¼šè½¬æ¢base64æ ¼å¼çš„appå›¾æ ‡ä»¥åŠåº”ç”¨å¯åŠ¨å›¾ï¼Œæ­¤æ­¥éª¤å¿…éœ€åœ¨ Update app iconsã€Update splash screenä¸¤æ­¥ä¹‹å‰æ‰§è¡Œ
      - name: Convert Base64 app icons and Base64 splash screen to png
        script: |
          set -e  # åœ¨å‘½ä»¤å‡ºé”™æ—¶é€€å‡ºè„šæœ¬
          
          echo "=== å¼€å§‹å¤„ç†åº”ç”¨å›¾æ ‡å’Œå¯åŠ¨å›¾ ==="
          # åˆ›å»ºå¿…è¦çš„ç›®å½•
          mkdir -p assets/icons
          mkdir -p assets/splash
          
          decode_or_download_image() {
            input=$1
            output_path=$2
            if echo "$input" | grep -q '^http'; then
              # å¦‚æœæ˜¯ URLï¼Œåˆ™ä½¿ç”¨ curl ä¸‹è½½
              echo "ä¸‹è½½å›¾åƒ: $input"
              if ! curl -L -o "$output_path" "$input"; then
                echo "âŒ å›¾åƒä¸‹è½½å¤±è´¥ï¼Œç»ˆæ­¢è„šæœ¬"
                exit 1
              fi
              echo "âœ… å›¾åƒå·²æˆåŠŸä¸‹è½½åˆ° $output_path"
            else
              # å¦‚æœæ˜¯ base64ï¼Œåˆ™è§£ç 
              if ! echo "$input" | sed 's/^data:image\/[^;]*;base64,//' | base64 -d > "$output_path" 2>/dev/null; then
                echo "âŒ base64è§£ç å¤±è´¥ï¼Œç»ˆæ­¢è„šæœ¬"
                exit 1
              fi
              echo "âœ… å›¾åƒå·²æˆåŠŸè§£ç åˆ° $output_path"
            fi
          }
          
          # å¤„ç† app å›¾æ ‡
          if [ -n "$APP_LUNCHER_ICON_BASE64" ]; then
            echo "å¤„ç† app å›¾æ ‡:"
            decode_or_download_image "$APP_LUNCHER_ICON_BASE64" "assets/icons/logo512.png"
          else
            echo "âŒ ç¼ºå°‘ APP_LUNCHER_ICON_BASE64ï¼Œç»ˆæ­¢è„šæœ¬"
            exit 1
          fi
          
          # å¤„ç† app å¯åŠ¨å›¾
          if [ -n "$APP_SPLASH_SCREEN_BASE64" ]; then
            echo "å¤„ç† app å¯åŠ¨å›¾:"
            decode_or_download_image "$APP_SPLASH_SCREEN_BASE64" "assets/splash/loadingPage2.png"
          else
            echo "âŒ ç¼ºå°‘ APP_SPLASH_SCREEN_BASE64ï¼Œç»ˆæ­¢è„šæœ¬"
            exit 1
          fi
          
          # å¤„ç† Android 12+ è®¾å¤‡ä¸Šçš„ app å¯åŠ¨é¡µä¸­é—´å°å›¾æ ‡
          if [ -n "$APP_ANDROID12_SPLASH_ICON_BASE64" ]; then
            echo "å¤„ç† Android 12+ è®¾å¤‡ä¸Šçš„ app å¯åŠ¨é¡µä¸­é—´å°å›¾æ ‡:"
            decode_or_download_image "$APP_ANDROID12_SPLASH_ICON_BASE64" "assets/splash/appLogo.png"
          else
            echo "âŒ ç¼ºå°‘ APP_ANDROID12_SPLASH_ICON_BASE64ï¼Œç»ˆæ­¢è„šæœ¬"
            exit 1
          fi
          
          # éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
          echo "éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶:"
          if [ ! -f assets/icons/logo512.png ]; then
            echo "âŒ assets/icons/logo512.png ä¸å­˜åœ¨"
            exit 1
          fi
          
          if [ ! -f assets/splash/loadingPage2.png ]; then
            echo "âŒ assets/splash/loadingPage2.png ä¸å­˜åœ¨"
            exit 1
          fi
          
          if [ ! -f assets/splash/appLogo.png ]; then
            echo "âŒ assets/splash/appLogo.png ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "=== å›¾æ ‡å’Œå¯åŠ¨å›¾å¤„ç†å®Œæˆ ==="

      # flutterï¼šæ›¿æ¢é¡¹ç›® flutter_native_splash.yaml æ–‡ä»¶ä¸­çš„å†…å®¹ï¼ˆå…¼å®¹å¤„ç†åœ¨android 12+ è®¾å¤‡ä¸Šå¯åŠ¨å›¾æ— æ³•ç”Ÿæ•ˆï¼‰
      - name: Update flutter flutter_native_splash.yaml
        script: |
          echo "Update flutter_native_splash.yaml..."
          sed -e "s|color: '[^']*'|color: '${APP_ANDROID12_SPLASH_BG}'|g" \
              -e "s|icon_background_color: '[^']*'|icon_background_color: '${APP_ANDROID12_SPLASH_BG}'|g" \
              -e "s|color_dark: '[^']*'|color_dark: '${APP_ANDROID12_SPLASH_BG}'|g" \
              -e "s|icon_background_color_dark: '[^']*'|icon_background_color_dark: '${APP_ANDROID12_SPLASH_BG}'|g" \
              flutter_native_splash.yaml > flutter_native_splash.yaml.tmp && mv flutter_native_splash.yaml.tmp flutter_native_splash.yaml

          echo "Verifying updated variables..."
          cat flutter_native_splash.yaml

      # flutterï¼šæ›´æ–°ç”¨æˆ·å›¾æ ‡ï¼Œæ­¤æ­¥éª¤éœ€å…ˆåœ¨flutteré¡¹ç›®ä¸­æ›´æ–°å›¾æ ‡èµ„æºæ–‡ä»¶åæ‰èƒ½åº”ç”¨æ–°å›¾æ ‡æˆ–æ‰§è¡Œ Convert Base64 app icons and Base64 splash screen to png æŠŠBase64çš„å›¾ç‰‡æ ¼å¼è½¬æ¢æˆpngå¹¶å­˜å‚¨åœ¨æŒ‡å®šèµ„æºç›®å½•ä¸‹æ‰èƒ½åº”ç”¨åˆ°æ–°å›¾æ ‡
      - name: Update app icons
        script: |
          echo "Update icons..."
          dart run flutter_launcher_icons

      # flutterï¼šæ›´æ–°å¯åŠ¨å›¾èµ„æºï¼Œæ­¤æ­¥éª¤éœ€å…ˆåœ¨flutteré¡¹ç›®ä¸­æ›´æ–°å¯åŠ¨é¡µèµ„æºæ–‡ä»¶åæ‰èƒ½åº”ç”¨æ–°çš„å¯åŠ¨å›¾æˆ–æ‰§è¡Œ Convert Base64 app icons and Base64 splash screen to png æŠŠBase64çš„å›¾ç‰‡æ ¼å¼è½¬æ¢æˆpngå¹¶å­˜å‚¨åœ¨æŒ‡å®šèµ„æºç›®å½•ä¸‹æ‰èƒ½åº”ç”¨åˆ°æ–°å›¾æ ‡
      - name: Update splash screen
        script: |
          echo "Updating splash screen..."
          dart run flutter_native_splash:create --path=./flutter_native_splash.yaml

      # flutterï¼šæ›´æ–°é¡¹ç›® webUrl.dart æ–‡ä»¶ä¸­çš„å†…å®¹
      - name: Update flutter webUrl.dart
        script: |
          echo "Update webUrl.dart..."
          # ç”±äº&åœ¨sedä¸­æ˜¯ç‰¹æ®Šè¯­æ³•ï¼Œå…ˆè‡ªåŠ¨å°† & è½¬ä¹‰ä¸º \&ï¼Œé¿å…é“¾æ¥ä¿®æ”¹å‡ºé”™
          REAL_WEB_URL=$(echo "$WEB_URL" | sed 's/&/\\&/g')
          sed -e "s#const String webUrl = '[^']*'#const String webUrl = '${REAL_WEB_URL}'#g" \
              -e "s#const String jpushAppKey = '[^']*'#const String jpushAppKey = '${JPUSH_APP_KEY}'#g" \
              lib/webUrl.dart > lib/webUrl.dart.tmp && mv lib/webUrl.dart.tmp lib/webUrl.dart
          
          echo "Verifying updated variables..."
          cat lib/webUrl.dart

      # android. æ‰“åŒ…æ„å»ºå®‰å“apk
      - name: Build apk with Flutter
        script: |
          flutter build apk \
            --build-name="${APP_VERSION}" --build-number="${BUILD_NUMBER}" \
            --no-tree-shake-icons --target-platform android-arm64


      # ios. å®‰è£… Pods
      # - name: Install pods
      #   script: |
      #     find . -name "Podfile" -execdir pod install \;

      # ios. æ‰“åŒ…æ„å»ºè‹¹æœipa
      # - name: Build ipa with Flutter
      #   script: |
      #     flutter build ipa --release \
      #       --build-name="${APP_VERSION}" --build-number="${BUILD_NUMBER}" \
      #       --export-options-plist=/Users/builder/export_options.plist

      # æŠ¥å‘Šæ„å»ºçŠ¶æ€
      - name: Build finished successfully
        script: touch ~/SUCCESS
    artifacts:
      - build/app/outputs/flutter-apk/**/*.apk
      - build/**/outputs/**/mapping.txt
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
    publishing:
      scripts:
        - name: Install wrangler
          script: npm install -g wrangler
        - name: Publish to Cloudflare R2
          script: |
            if [  -f ~/SUCCESS ] ; then
               # build successful
                echo "Start to upload .apk to R2"
                PWD="$(pwd)"
                echo "PWD: ${PWD}"
            
                R2_OBJECT_PATH="${R2_BUCKET}/${BUCKET_FILEPATH}/app-release.apk"
                echo "R2_OBJECT_PATH: ${R2_OBJECT_PATH}"
            
                LOCAL_PATH="${PWD}/build/app/outputs/flutter-apk/app-release.apk"
                echo "LOCAL_PATH: ${LOCAL_PATH}"
                
                # æ£€æŸ¥apkæ–‡ä»¶æ˜¯å¦å­˜åœ¨
                if [ ! -f "${LOCAL_PATH}" ] ; then
                  echo "âŒ ${LOCAL_PATH} ä¸å­˜åœ¨"
                  exit 1
                else 
                  echo "âœ… ${LOCAL_PATH} å­˜åœ¨"
                fi
                
                # æ‰“å°wranglerå‘½ä»¤çš„æ–‡æœ¬
                echo "ğŸš€ do run: wrangler r2 object put \"${R2_OBJECT_PATH}\" --file=\"${LOCAL_PATH}\" --remote --content-type \"application/vnd.android.package-archive\" "
            
                wrangler r2 object put "${R2_OBJECT_PATH}" --file="${LOCAL_PATH}" --remote --content-type "application/vnd.android.package-archive"
            
                echo "End to upload .apk to R2"
            else
               # build failed
               echo "Build failed, skipping APK upload"
            fi
  #      email:
  #        recipients:
  #          - xx@x.com
  #        notify:
  #          success: true
  #          failure: false

  # Flutteræ„å»ºæµæ°´çº¿ï¼ˆioséç­¾åç‰ˆæœ¬ï¼‰
  flutter-workflow-nosign:
    name: Flutter Workflow Nosign
    instance_type: mac_mini_m2
    max_build_duration: 120
    environment:
      # androidç­¾åä¿¡æ¯
      android_signing:
        - cc_game_apk_jks
      vars:
        # è‡ªå®šä¹‰åŒ…åï¼Œä¿®æ”¹åå½±å“è¾ƒå¤§
        # iosæ¨é€è¯ä¹¦æœªçŸ¥ï¼Œandroidéœ€æ›´æ–°æ¨é€å¹³å°ä¿¡æ¯
        PACKAGE_NAME: "com.ccgametest.life"
        # è‡ªå®šä¹‰å¾…åŠ è½½çš„æå…‰æ¨é€çš„ JPUSH_APP_KEYã€ä¸ PACKAGE_NAME åŒ…åé«˜åº¦ç»‘å®šï¼Œä¸€æ—¦åŒ…åå˜æ›´ï¼Œæ­¤å€¼ä¹Ÿé¡»å˜æ›´ï¼Œä¸»è¦å—æ¨é€å¹³å°å½±å“ã€‘
        JPUSH_APP_KEY: "8b68b9303424eadca9e99ae9"
        # è‡ªå®šä¹‰åº”ç”¨ç‰ˆæœ¬å·
        APP_VERSION: "1.0.1"
        # è‡ªå®šä¹‰åº”ç”¨æ„å»ºå·
        BUILD_NUMBER: "1"
        # è‡ªå®šä¹‰åº”ç”¨åç§°
        APP_NAME: "CC GAME 2"
        # è‡ªå®šä¹‰å¾…åŠ è½½çš„ web ç½‘å€ ä»¥åŠ ç½‘å€ä¸­ç”¨æ¥è¯·æ±‚çš„apié“¾æ¥
        WEB_URL: "https://reimagined-memory-jjgwj4xwqgxrfq4p4-8080.app.github.dev?baseUrl=https://9212-bankski-game-v1h88uwaamm.ws-us121.gitpod.io"

      flutter: stable
      xcode: latest
      cocoapods: default
    scripts:
      # android. é…ç½®local.properties
      - name: Set up local.properties
        script: |
          echo "flutter.sdk=$HOME/programs/flutter" > "$CM_BUILD_DIR/android/local.properties"

      # è·å–Flutterä¾èµ–
      - name: Get Flutter packages
        script: |
          flutter pub get

      # flutterï¼šä¿®æ”¹åº”ç”¨åŒ…åï¼ˆandroidã€iosï¼‰
      # ä¿®æ”¹ååŒ…åä¸º PACKAGE_NAME å¯¹åº”çš„å€¼ï¼Œiosæ¨é€è¯ä¹¦æœªçŸ¥ï¼Œandroidéœ€æ›´æ–°æ¨é€å¹³å°ä¿¡æ¯
      - name: Update android ios package name
        script: |
          echo "Update android ios package name..."
          dart run change_app_package_name:main "${PACKAGE_NAME}"

      # flutterï¼šæ›´æ–°åº”ç”¨åç§°
      - name: Update app name
        script: |
          echo "Updating app name..."
          dart run rename_app:main all="${APP_NAME}"

      # flutterï¼šæ›´æ–°ç”¨æˆ·å›¾æ ‡ï¼Œæ­¤æ­¥éª¤éœ€å…ˆåœ¨flutteré¡¹ç›®ä¸­æ›´æ–°å›¾æ ‡èµ„æºæ–‡ä»¶åæ‰èƒ½åº”ç”¨æ–°å›¾æ ‡
      - name: Update app icons
        script: |
          echo "Update icons..."
          dart run flutter_launcher_icons

      # flutterï¼šæ›´æ–°å¯åŠ¨å›¾èµ„æºï¼Œæ­¤æ­¥éª¤éœ€å…ˆåœ¨flutteré¡¹ç›®ä¸­æ›´æ–°å¯åŠ¨é¡µèµ„æºæ–‡ä»¶åæ‰èƒ½åº”ç”¨æ–°çš„å¯åŠ¨å›¾
      - name: Update splash screen
        script: |
          echo "Updating splash screen..."
          dart run flutter_native_splash:create --path=./flutter_native_splash.yaml

      # flutterï¼šæ›´æ–°é¡¹ç›® webUrl.dart æ–‡ä»¶ä¸­çš„å†…å®¹
      - name: Update flutter webUrl.dart
        script: |
          echo "Update webUrl.dart..."
          sed -e "s#const String webUrl = '[^']*'#const String webUrl = '${WEB_URL}'#g" \
              -e "s#const String jpushAppKey = '[^']*'#const String jpushAppKey = '${JPUSH_APP_KEY}'#g" \
              lib/webUrl.dart > lib/webUrl.dart.tmp && mv lib/webUrl.dart.tmp lib/webUrl.dart
          
          echo "Verifying updated variables..."
          cat lib/webUrl.dart

      # android. æ‰“åŒ…æ„å»ºå®‰å“apk
      - name: Build apk with Flutter
        script: |
          flutter build apk \
            --build-name="${APP_VERSION}" --build-number="${BUILD_NUMBER}" \
            --no-tree-shake-icons --split-per-abi

      # ios. å®‰è£… Pods
      - name: Install pods
        script: |
          find . -name "Podfile" -execdir pod install \;

      # ios. æ‰“åŒ…æ„å»ºè‹¹æœipa (æœªç­¾å)
      - name: Build unsigned ipa with Flutter
        script: |
          flutter build ios --release \
            --no-codesign \
            --build-name="${APP_VERSION}" --build-number="${BUILD_NUMBER}"
          
          mkdir -p build/ios/ipa
          cd build/ios/iphoneos
          mkdir -p Payload
          cp -r Runner.app Payload/
          zip -r ../ipa/Runner-unsigned.ipa Payload

    artifacts:
      - build/app/outputs/flutter-apk/**/*.apk
      - build/**/outputs/**/mapping.txt
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
