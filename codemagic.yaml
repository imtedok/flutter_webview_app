workflows:
  flutter_webview_app:
    name: Flutter WebView App
    max_build_duration: 60
    environment:
      groups:
        - base # 包含 PGYER_UKEY 和 PGYER_API_KEY
      flutter: stable
      xcode: latest
      cocoapods: default

      # iOS 代码签名配置 - 移除不支持的 automatic: true
      # 自动代码签名需要在 Codemagic Web 界面中配置
      ios_signing:
        # 指定分发类型
        distribution_type: ad_hoc # 可选: ad_hoc, app_store, development, enterprise
        bundle_identifier: com.ccgametest.live
        # 确保在 Codemagic Web 界面中配置了自动代码签名

    cache:
      cache_paths:
        - $HOME/.pub-cache
        - $HOME/.gradle/caches

    scripts:
      - name: Install dependencies
        script: |
          flutter pub get

      - name: Check Flutter environment
        script: |
          flutter doctor -v

      # Android 构建
      - name: Build Android APK
        script: |
          flutter build apk --no-tree-shake-icons --split-per-abi

      # iOS 构建
      - name: Build iOS IPA
        script: |
          echo "开始构建 iOS IPA..."
          
          # 创建导出选项文件
          cat > export_options.plist <<EOL
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>ad-hoc</string>
            <key>teamID</key>
            <string>X9A9C8FGQ6</string>
            <key>compileBitcode</key>
            <false/>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <true/>
          </dict>
          </plist>
          EOL
          
          echo "导出选项文件内容:"
          cat export_options.plist
          
          # 使用 flutter build ipa 构建
          flutter build ipa --release --no-tree-shake-icons \
            --export-options-plist $CM_BUILD_DIR/export_options.plist
          
          echo "构建完成，检查输出目录:"
          ls -la $CM_BUILD_DIR/build/ios/ipa/

    artifacts:
      - build/app/outputs/flutter-apk/**/*.apk
      - build/ios/ipa/*.ipa

    publishing:
      email:
        recipients:
          - xs121913958@163.com

      scripts:
        - name: Upload to Pgyer
          script: |
            # 上传 Android APK
            for apk in $(find build/app/outputs/flutter-apk -name "*.apk"); do
              echo "上传 Android APK: $apk 到蒲公英..."
              curl -F "file=@$apk" \
                   -F "uKey=$PGYER_UKEY" \
                   -F "_api_key=$PGYER_API_KEY" \
                   https://www.pgyer.com/apiv2/app/upload
              echo ""
            done

            # 上传 iOS IPA
            IPA_PATH="$CM_BUILD_DIR/build/ios/ipa/Runner.ipa"
            if [ -f "$IPA_PATH" ]; then
              echo "上传 iOS IPA 到蒲公英..."
              curl -F "file=@$IPA_PATH" \
                   -F "uKey=$PGYER_UKEY" \
                   -F "_api_key=$PGYER_API_KEY" \
                   https://www.pgyer.com/apiv2/app/upload
            else
              echo "警告: 未找到 IPA 文件 $IPA_PATH"
              # 尝试查找任何 IPA 文件
              find $CM_BUILD_DIR -name "*.ipa" -exec echo "找到IPA文件: {}" \;
            fi